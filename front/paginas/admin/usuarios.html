<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Gecko Dev</title>
    
   <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">

     <link rel="stylesheet" href="../../dist/style/css/tailwind.css">
    <style>
        body { font-family: 'Lato', sans-serif; background-color: #f4f7f6; }
        .breadcrumb-item + .breadcrumb-item::before { content: "/"; color: #dee2e6; }
        .table-hover tbody tr:hover { background-color: #f2f2f2 !important; cursor: pointer; }
        /* Ajuste para que el modal de Bootstrap no se vea afectado por Tailwind */
        .modal-backdrop { z-index: 1040 !important; }
        .modal { z-index: 1050 !important; }
    </style>

    <script type="module">
        import { Auth } from '../../dist/js/auth.js';
        import { API } from '../../dist/js/api.js';
        import { initMenu } from '../../dist/js/components/MenuComponent.js';
        import { showLoader, hideLoader } from '../../dist/js/components/LoaderComponent.js';
        import { NotificationManager } from '../../dist/js/NotificationManager.js';
        import { checkUrlParamsAndOpen } from '../../dist/js/components/UrlRouter.js';
        import { loadLanguage } from '../../dist/js/utils/i18n.js';
        // Lógica administrativa de usuarios (Alta, baja, modificación y asignación de roles)
        import { initUsuariosPage } from '../../dist/js/pages/admin/usuarios.js';

        document.addEventListener('DOMContentLoaded', async () => {
            showLoader();

            try {
                // 1. CARGA CRÍTICA: Idioma
                // Bloqueamos la ejecución para asegurar que las traducciones de roles estén listaás
                await loadLanguage(); 

                // 2. VALIDACIÓN DE ACCESO (Niveles administrativos y de gestión)
                Auth.checkAccess([1, 2, 4, 5, 6]); 

                // 3. INICIALIZACIÓN DE COMPONENTES
                if (window.txt) {
                    initMenu();
                    NotificationManager.init();
                    
                    // Inicialización de la lógica de gestión de usuarios
                    initUsuariosPage();
                    
                    console.log("✅ Administración de Usuarios inicializada correctamente.");
                } else {
                    throw new Error("El objeto de idioma window.txt no se generó.");
                }

                // 4. ROUTER (Delay para permitir que la tabla de usuarios se renderice)
                setTimeout(() => {
                    checkUrlParamsAndOpen();
                }, 300);

            } catch (error) {
                console.error("❌ Fallo en inicialización de página de Usuarios:", error);
            } finally {
                hideLoader();
            }
        });
    </script>
    
</head>
<body>

    <div class="container my-5">
        <div class="card shadow-sm border-0 p-4 p-md-5">
            
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb text-uppercase fw-bold" style="font-size: 10px; letter-spacing: 1px;">
                    <li class="breadcrumb-item text-muted">GROBO</li>
                    <li class="breadcrumb-item text-muted" id="institucionbread"></li>
                    <li class="breadcrumb-item text-muted">Admin</li>
                    <li class="breadcrumb-item active">
                        <span class="badge bg-success px-2 py-1" style="background-color: #1a5d3b !important;">Gestión Usuarios</span>
                    </li>
                </ol>
            </nav>

            <div class="row align-items-end mb-4 pb-3 border-bottom">
                <div class="col-lg-8">
                    <h1 class="h4 text-secondary text-uppercase mb-4">Directorio de Usuarios</h1>
                    
                    <div class="input-group shadow-sm" style="max-width: 500px;">
                        <span class="input-group-text bg-light text-muted fw-bold small uppercase" style="font-size: 10px;">Filtrar:</span>
                                <select id="filter-type" class="form-select form-select-sm fw-bold" style="max-width: 150px;">
                                    <option value="all">TODOS</option>
                                    <option value="IdUsrA">ID</option>
                                    <option value="Usuario">Usuario</option>
                                    <option value="ApellidoA">Apellido</option>
                                    <option value="NombreA">Nombre</option>
                                    <option value="CelularA">Celular</option>
                                    <option value="Correo">Correo</option>
                                    <option value="Laboratorio">Laboratorio</option>
                                    <option value="OtrosCEUAS">Otros CEUAS</option>
                                </select>
                        <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Escribe...">
                        <button id="btn-search" class="btn btn-success fw-bold px-4" style="background-color: #1a5d3b;">Buscar</button>
                    </div>
                </div>

                <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                    <button id="btn-excel" class="btn btn-outline-secondary btn-sm fw-bold px-3 uppercase">Excel</button>
                    <button 
    id="btn-ayuda" 
    class="btn btn-outline-secondary btn-sm fw-bold px-3 uppercase" 
    data-bs-toggle="modal" 
    data-bs-target="#modal-ayuda">
    <i class="bi bi-question-circle me-1"></i> Ayuda
</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle border" style="font-size: 12px;">
                    <thead class="table-light">
                        <tr class="text-uppercase" style="font-size: 11px;">
                            <th data-key="IdUsrA" data-sortable="true" class="py-3 px-3">ID - </th>
                            <th data-key="Usuario" data-sortable="true" class="py-3 px-3">Usuario - </th>
                            <th data-key="ApellidoA" data-sortable="true" class="py-3 px-3">Apellido y Nombre - </th>
                            <th data-key="CelularA" data-sortable="true" class="py-3 px-3">Celular - </th>
                            <th data-key="Correo" data-sortable="true" class="py-3 px-3">Correo - </th>
                            <th data-key="Laboratorio" data-sortable="true" class="py-3 px-3">Laboratorio - </th>
                            <th data-key="OtrosCEUAS" class="py-3 px-3 text-center">Otros CEUAS - </th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
            </div>

            <nav aria-label="Page navigation" class="mt-5">
                <ul id="pagination" class="pagination pagination-sm justify-content-center">
                </ul>
            </nav>
        </div>
    </div>

    <div class="modal fade" id="modal-user" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 border-top border-5 border-success shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title small fw-bold text-uppercase tracking-widest">Detalles del Registro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="modal-content" class="modal-body p-4 p-md-5">
                    </div>
            </div>
        </div>
    </div>
<div class="modal fade" id="modal-ayuda" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-question-circle me-2"></i>Guía de Uso
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                
                <section class="mb-4">
                    <h6 class="fw-black text-uppercase text-success small mb-2">1. Búsqueda y Filtrado Inteligente</h6>
                    <p class="text-muted small">Localice rápidamente a cualquier usuario utilizando las herramientas de la barra superior:</p>
                    <ul class="small mb-0">
                        <li><strong>Criterio de Búsqueda:</strong> Seleccione en el menú desplegable si desea buscar por <b>Apellido</b>, <b>Nombre</b> o <b>Usuario</b>.</li>
                        <li><strong>Filtro "Otros CEUAS":</strong> Escriba <span class="badge bg-light text-dark border">otros</span> para ver usuarios con protocolos externos o <span class="badge bg-light text-dark border">no</span> para los que no tienen.</li>
                        <li><strong>Ejecución:</strong> Presione el botón verde <b>"Buscar"</b> para refrescar la lista.</li>
                    </ul>
                </section>

                <hr class="text-light">

                <section class="mb-4">
                    <h6 class="fw-black text-uppercase text-success small mb-2">2. Edición y Ficha del Usuario</h6>
                    <p class="text-muted small">Haga clic sobre <b>cualquier fila</b> de la tabla para abrir la ventana de edición:</p>
                    <ul class="small mb-0">
                        <li><strong>Datos Personales:</strong> Puede actualizar Nombre, Apellido, Email, Celular y asignar un <b>Departamento</b>.</li>
                        <li><strong>Seguridad:</strong> El botón amarillo permite resetear la contraseña del usuario a <code class="bg-warning-subtle px-1">12345678</code>.</li>
                        <li><strong>Historial Dinámico:</strong> En la parte inferior de la ficha verá los <b>Protocolos</b> y <b>Formularios</b> vinculados a ese usuario.</li>
                    </ul>
                </section>

                <hr class="text-light">

                <section>
                    <h6 class="fw-black text-uppercase text-success small mb-2">3. Reportes y Documentación</h6>
                    <ul class="small mb-0">
                        <li><strong>Excel General:</strong> Descargue la lista completa de usuarios (según sus filtros actuales) desde el botón <b>"Excel"</b> superior.</li>
                        <li><strong>Ficha en PDF:</strong> Dentro de cada usuario, encontrará botones rojos para descargar la <b>Ficha Total</b> (con historial) o la <b>Ficha Básica</b> (solo datos personales).</li>
                    </ul>
                </section>

            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-success fw-bold w-100 uppercase" data-bs-dismiss="modal">Entendido</button>
            </div>
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>